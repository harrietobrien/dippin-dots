#!/usr/bin/env bash
# harrietobrien

set -euo pipefail

# accepts anaconda terms of service for default channels,
# or switches to conda-forge only with --forge

PATH="/opt/anaconda"
MODE="${1:-accept}"   # "accept" (default) or "--forge"

# load conda if available
if [ -f "$PATH/etc/profile.d/conda.sh" ]; then
  # shellcheck disable=SC1091
  source "$PATH/etc/profile.d/conda.sh"
  conda activate base >/dev/null 2>&1 || true
fi

if ! command -v conda >/dev/null 2>&1; then
  echo "conda not found. ensure anaconda is installed and conda is on PATH."
  echo "Source $PATH/etc/profile.d/conda.sh..."
  exit 1
fi

if [ "$MODE" = "--forge" ]; then
  echo "Switching to conda-forge only (no ToS prompts)"
  # remove common anaconda-hosted channels if present (ignore failures)
  conda config --remove channels defaults >/dev/null 2>&1 || true
  conda config --remove channels https://repo.anaconda.com/pkgs/main >/dev/null 2>&1 || true
  conda config --remove channels https://repo.anaconda.com/pkgs/r >/dev/null 2>&1 || true
  conda config --remove channels https://repo.anaconda.com/pkgs/msys2 >/dev/null 2>&1 || true

  # add conda-forge and set strict priority
  conda config --add channels conda-forge
  conda config --set channel_priority strict

  echo "Conda-forge configured."
  exit 0
fi

# default path: accept ToS for anaconda-hosted channels
CHANNELS=(
  "https://repo.anaconda.com/pkgs/main"
  "https://repo.anaconda.com/pkgs/r"
  "https://repo.anaconda.com/pkgs/msys2"
)

echo "[*] accepting anaconda tos for default channelsâ€¦"
for ch in "${CHANNELS[@]}"; do
  echo "    -> $ch"
  conda tos accept --override-channels --channel "$ch"
done

echo "ToS accepted for listed channels."

